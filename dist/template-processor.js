"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.processTemplate = processTemplate;
exports.replaceTemplate = replaceTemplate;

var _immutable = require("immutable");

var _ramdaFantasy = require("ramda-fantasy");

var _ramda = require("ramda");

var _ramda2 = _interopRequireDefault(_ramda);

var _syntax = require("./syntax");

var _syntax2 = _interopRequireDefault(_syntax);

var _errors = require("./errors");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var isDolar_698 = function isDolar_698(s_706) {
  return s_706 && s_706 instanceof _syntax2.default && s_706.isIdentifier() && s_706.val() === "$";
};
var isDelimiter_699 = function isDelimiter_699(s_707) {
  return s_707 && typeof s_707.isDelimiter === "function" && s_707.isDelimiter();
};
var isBraces_700 = function isBraces_700(s_708) {
  return s_708 && typeof s_708.isBraces === "function" && s_708.isBraces();
};
var isParens_701 = function isParens_701(s_709) {
  return s_709 && typeof s_709.isParens === "function" && s_709.isParens();
};
var isBrackets_702 = function isBrackets_702(s_710) {
  return s_710 && typeof s_710.isBrackets === "function" && s_710.isBrackets();
};
var insertIntoDelimiter_703 = _ramda2.default.cond([[isBraces_700, function (s_711, r_712) {
  return _syntax2.default.fromBraces(r_712, s_711);
}], [isParens_701, function (s_713, r_714) {
  return _syntax2.default.fromParens(r_714, s_713);
}], [isBrackets_702, function (s_715, r_716) {
  return _syntax2.default.fromBrackets(r_716, s_715);
}]]);
var process_704 = function process_704(acc_717, s_718) {
  if (isBraces_700(s_718) && isDolar_698(acc_717.template.last())) {
    return { template: acc_717.template.push(_syntax2.default.fromBraces(_immutable.List.of(_syntax2.default.fromNumber(acc_717.interp.size)), s_718)), interp: acc_717.interp.push(s_718.inner()) };
  } else if (isDelimiter_699(s_718)) {
    var innerResult = processTemplate(s_718.inner(), acc_717.interp);
    return { template: acc_717.template.push(insertIntoDelimiter_703(s_718, innerResult.template)), interp: innerResult.interp };
  } else {
    return { template: acc_717.template.push(s_718), interp: acc_717.interp };
  }
};
var replace_705 = function replace_705(acc_719, s_720) {
  if (isBraces_700(s_720) && isDolar_698(acc_719.template.last())) {
    var index = s_720.inner().first().val();
    (0, _errors.assert)(acc_719.rep.size > index, "unknown replacement value");
    return { template: acc_719.template.pop().concat(acc_719.rep.get(index)), rep: acc_719.rep };
  } else if (isDelimiter_699(s_720)) {
    var innerResult = replaceTemplate(s_720.inner(), acc_719.rep);
    return { template: acc_719.template.push(insertIntoDelimiter_703(s_720, innerResult)), rep: acc_719.rep };
  } else {
    return { template: acc_719.template.push(s_720), rep: acc_719.rep };
  }
};
function processTemplate(temp_721) {
  var interp_722 = arguments.length <= 1 || arguments[1] === undefined ? (0, _immutable.List)() : arguments[1];

  return temp_721.reduce(process_704, { template: (0, _immutable.List)(), interp: interp_722 });
}
function replaceTemplate(temp_723, rep_724) {
  return temp_723.reduce(replace_705, { template: (0, _immutable.List)(), rep: rep_724 }).template;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3N3ZWV0L3RlbXBsYXRlLXByb2Nlc3Nvci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztRQWlDZ0IsZSxHQUFBLGU7UUFHQSxlLEdBQUEsZTs7QUFwQ2hCOztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBLElBQU0sY0FBYyxTQUFkLFdBQWM7QUFBQSxTQUFTLFNBQVMsaUNBQVQsSUFBb0MsTUFBTSxZQUFOLEVBQXBDLElBQTRELE1BQU0sR0FBTixPQUFnQixHQUFyRjtBQUFBLENBQXBCO0FBQ0EsSUFBTSxrQkFBa0IsU0FBbEIsZUFBa0I7QUFBQSxTQUFTLFNBQVMsT0FBTyxNQUFNLFdBQWIsS0FBNkIsVUFBdEMsSUFBb0QsTUFBTSxXQUFOLEVBQTdEO0FBQUEsQ0FBeEI7QUFDQSxJQUFNLGVBQWUsU0FBZixZQUFlO0FBQUEsU0FBUyxTQUFTLE9BQU8sTUFBTSxRQUFiLEtBQTBCLFVBQW5DLElBQWlELE1BQU0sUUFBTixFQUExRDtBQUFBLENBQXJCO0FBQ0EsSUFBTSxlQUFlLFNBQWYsWUFBZTtBQUFBLFNBQVMsU0FBUyxPQUFPLE1BQU0sUUFBYixLQUEwQixVQUFuQyxJQUFpRCxNQUFNLFFBQU4sRUFBMUQ7QUFBQSxDQUFyQjtBQUNBLElBQU0saUJBQWlCLFNBQWpCLGNBQWlCO0FBQUEsU0FBUyxTQUFTLE9BQU8sTUFBTSxVQUFiLEtBQTRCLFVBQXJDLElBQW1ELE1BQU0sVUFBTixFQUE1RDtBQUFBLENBQXZCO0FBQ0EsSUFBTSwwQkFBMEIsZ0JBQUUsSUFBRixDQUFPLENBQUMsQ0FBQyxZQUFELEVBQWUsVUFBQyxLQUFELEVBQVEsS0FBUjtBQUFBLFNBQWtCLGlCQUFPLFVBQVAsQ0FBa0IsS0FBbEIsRUFBeUIsS0FBekIsQ0FBbEI7QUFBQSxDQUFmLENBQUQsRUFBb0UsQ0FBQyxZQUFELEVBQWUsVUFBQyxLQUFELEVBQVEsS0FBUjtBQUFBLFNBQWtCLGlCQUFPLFVBQVAsQ0FBa0IsS0FBbEIsRUFBeUIsS0FBekIsQ0FB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QUNEIiwiZmlsZSI6InRlbXBsYXRlLXByb2Nlc3Nvci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7TGlzdH0gZnJvbSBcImltbXV0YWJsZVwiO1xuaW1wb3J0IHtNYXliZX0gZnJvbSBcInJhbWRhLWZhbnRhc3lcIjtcbmltcG9ydCBfIGZyb20gXCJyYW1kYVwiO1xuaW1wb3J0IFN5bnRheCBmcm9tIFwiLi9zeW50YXhcIjtcbmltcG9ydCB7YXNzZXJ0fSBmcm9tIFwiLi9lcnJvcnNcIjtcbmNvbnN0IGlzRG9sYXJfNjk4ID0gc183MDYgPT4gc183MDYgJiYgc183MDYgaW5zdGFuY2VvZiBTeW50YXggJiYgc183MDYuaXNJZGVudGlmaWVyKCkgJiYgc183MDYudmFsKCkgPT09IFwiJFwiO1xuY29uc3QgaXNEZWxpbWl0ZXJfNjk5ID0gc183MDcgPT4gc183MDcgJiYgdHlwZW9mIHNfNzA3LmlzRGVsaW1pdGVyID09PSBcImZ1bmN0aW9uXCIgJiYgc183MDcuaXNEZWxpbWl0ZXIoKTtcbmNvbnN0IGlzQnJhY2VzXzcwMCA9IHNfNzA4ID0+IHNfNzA4ICYmIHR5cGVvZiBzXzcwOC5pc0JyYWNlcyA9PT0gXCJmdW5jdGlvblwiICYmIHNfNzA4LmlzQnJhY2VzKCk7XG5jb25zdCBpc1BhcmVuc183MDEgPSBzXzcwOSA9PiBzXzcwOSAmJiB0eXBlb2Ygc183MDkuaXNQYXJlbnMgPT09IFwiZnVuY3Rpb25cIiAmJiBzXzcwOS5pc1BhcmVucygpO1xuY29uc3QgaXNCcmFja2V0c183MDIgPSBzXzcxMCA9PiBzXzcxMCAmJiB0eXBlb2Ygc183MTAuaXNCcmFja2V0cyA9PT0gXCJmdW5jdGlvblwiICYmIHNfNzEwLmlzQnJhY2tldHMoKTtcbmNvbnN0IGluc2VydEludG9EZWxpbWl0ZXJfNzAzID0gXy5jb25kKFtbaXNCcmFjZXNfNzAwLCAoc183MTEsIHJfNzEyKSA9PiBTeW50YXguZnJvbUJyYWNlcyhyXzcxMiwgc183MTEpXSwgW2lzUGFyZW5zXzcwMSwgKHNfNzEzLCByXzcxNCkgPT4gU3ludGF4LmZyb21QYXJlbnMocl83MTQsIHNfNzEzKV0sIFtpc0JyYWNrZXRzXzcwMiwgKHNfNzE1LCByXzcxNikgPT4gU3ludGF4LmZyb21CcmFja2V0cyhyXzcxNiwgc183MTUpXV0pO1xuY29uc3QgcHJvY2Vzc183MDQgPSAoYWNjXzcxNywgc183MTgpID0+IHtcbiAgaWYgKGlzQnJhY2VzXzcwMChzXzcxOCkgJiYgaXNEb2xhcl82OTgoYWNjXzcxNy50ZW1wbGF0ZS5sYXN0KCkpKSB7XG4gICAgcmV0dXJuIHt0ZW1wbGF0ZTogYWNjXzcxNy50ZW1wbGF0ZS5wdXNoKFN5bnRheC5mcm9tQnJhY2VzKExpc3Qub2YoU3ludGF4LmZyb21OdW1iZXIoYWNjXzcxNy5pbnRlcnAuc2l6ZSkpLCBzXzcxOCkpLCBpbnRlcnA6IGFjY183MTcuaW50ZXJwLnB1c2goc183MTguaW5uZXIoKSl9O1xuICB9IGVsc2UgaWYgKGlzRGVsaW1pdGVyXzY5OShzXzcxOCkpIHtcbiAgICBsZXQgaW5uZXJSZXN1bHQgPSBwcm9jZXNzVGVtcGxhdGUoc183MTguaW5uZXIoKSwgYWNjXzcxNy5pbnRlcnApO1xuICAgIHJldHVybiB7dGVtcGxhdGU6IGFjY183MTcudGVtcGxhdGUucHVzaChpbnNlcnRJbnRvRGVsaW1pdGVyXzcwMyhzXzcxOCwgaW5uZXJSZXN1bHQudGVtcGxhdGUpKSwgaW50ZXJwOiBpbm5lclJlc3VsdC5pbnRlcnB9O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiB7dGVtcGxhdGU6IGFjY183MTcudGVtcGxhdGUucHVzaChzXzcxOCksIGludGVycDogYWNjXzcxNy5pbnRlcnB9O1xuICB9XG59O1xuY29uc3QgcmVwbGFjZV83MDUgPSAoYWNjXzcxOSwgc183MjApID0+IHtcbiAgaWYgKGlzQnJhY2VzXzcwMChzXzcyMCkgJiYgaXNEb2xhcl82OTgoYWNjXzcxOS50ZW1wbGF0ZS5sYXN0KCkpKSB7XG4gICAgbGV0IGluZGV4ID0gc183MjAuaW5uZXIoKS5maXJzdCgpLnZhbCgpO1xuICAgIGFzc2VydChhY2NfNzE5LnJlcC5zaXplID4gaW5kZXgsIFwidW5rbm93biByZXBsYWNlbWVudCB2YWx1ZVwiKTtcbiAgICByZXR1cm4ge3RlbXBsYXRlOiBhY2NfNzE5LnRlbXBsYXRlLnBvcCgpLmNvbmNhdChhY2NfNzE5LnJlcC5nZXQoaW5kZXgpKSwgcmVwOiBhY2NfNzE5LnJlcH07XG4gIH0gZWxzZSBpZiAoaXNEZWxpbWl0ZXJfNjk5KHNfNzIwKSkge1xuICAgIGxldCBpbm5lclJlc3VsdCA9IHJlcGxhY2VUZW1wbGF0ZShzXzcyMC5pbm5lcigpLCBhY2NfNzE5LnJlcCk7XG4gICAgcmV0dXJuIHt0ZW1wbGF0ZTogYWNjXzcxOS50ZW1wbGF0ZS5wdXNoKGluc2VydEludG9EZWxpbWl0ZXJfNzAzKHNfNzIwLCBpbm5lclJlc3VsdCkpLCByZXA6IGFjY183MTkucmVwfTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4ge3RlbXBsYXRlOiBhY2NfNzE5LnRlbXBsYXRlLnB1c2goc183MjApLCByZXA6IGFjY183MTkucmVwfTtcbiAgfVxufTtcbmV4cG9ydCBmdW5jdGlvbiBwcm9jZXNzVGVtcGxhdGUodGVtcF83MjEsIGludGVycF83MjIgPSBMaXN0KCkpIHtcbiAgcmV0dXJuIHRlbXBfNzIxLnJlZHVjZShwcm9jZXNzXzcwNCwge3RlbXBsYXRlOiBMaXN0KCksIGludGVycDogaW50ZXJwXzcyMn0pO1xufVxuZXhwb3J0IGZ1bmN0aW9uIHJlcGxhY2VUZW1wbGF0ZSh0ZW1wXzcyMywgcmVwXzcyNCkge1xuICByZXR1cm4gdGVtcF83MjMucmVkdWNlKHJlcGxhY2VfNzA1LCB7dGVtcGxhdGU6IExpc3QoKSwgcmVwOiByZXBfNzI0fSkudGVtcGxhdGU7XG59XG4iXX0=