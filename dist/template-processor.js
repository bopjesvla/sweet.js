"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.processTemplate = processTemplate;
exports.replaceTemplate = replaceTemplate;

var _immutable = require("immutable");

var _ramdaFantasy = require("ramda-fantasy");

var _ramda = require("ramda");

var _ramda2 = _interopRequireDefault(_ramda);

var _syntax = require("./syntax");

var _syntax2 = _interopRequireDefault(_syntax);

var _errors = require("./errors");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var isDolar_701 = function isDolar_701(s_710) {
  return s_710 && s_710 instanceof _syntax2.default && s_710.isIdentifier() && s_710.val() === "$";
};
var isDelimiter_702 = function isDelimiter_702(s_711) {
  return s_711 && typeof s_711.isDelimiter === "function" && s_711.isDelimiter();
};
var isBraces_703 = function isBraces_703(s_712) {
  return s_712 && typeof s_712.isBraces === "function" && s_712.isBraces();
};
var isParens_704 = function isParens_704(s_713) {
  return s_713 && typeof s_713.isParens === "function" && s_713.isParens();
};
var isBrackets_705 = function isBrackets_705(s_714) {
  return s_714 && typeof s_714.isBrackets === "function" && s_714.isBrackets();
};
var insertIntoDelimiter_706 = _ramda2.default.cond([[isBraces_703, function (s_715, r_716) {
  return _syntax2.default.fromBraces(r_716, s_715);
}], [isParens_704, function (s_717, r_718) {
  return _syntax2.default.fromParens(r_718, s_717);
}], [isBrackets_705, function (s_719, r_720) {
  return _syntax2.default.fromBrackets(r_720, s_719);
}]]);
var process_707 = function process_707(acc_721, s_722) {
  if (isBraces_703(s_722) && isDolar_701(acc_721.template.last())) {
    return { template: acc_721.template.push(_syntax2.default.fromBraces(_immutable.List.of(_syntax2.default.fromNumber(acc_721.interp.size)), s_722)), interp: acc_721.interp.push(s_722.inner()) };
  } else if (isDelimiter_702(s_722)) {
    var innerResult = processTemplate(s_722.inner(), acc_721.interp);
    return { template: acc_721.template.push(insertIntoDelimiter_706(s_722, innerResult.template)), interp: innerResult.interp };
  } else {
    return { template: acc_721.template.push(s_722), interp: acc_721.interp };
  }
};
function cloneLineNumber_708(to_723, from_724) {
  if (from_724 && to_723 && typeof to_723.setLineNumber === "function") {
    return to_723.setLineNumber(from_724.lineNumber());
  }
  return to_723;
}
var replace_709 = function replace_709(acc_725, s_726) {
  var last_727 = acc_725.template.get(-1);
  var beforeLast_728 = acc_725.template.get(-2);
  if (isBraces_703(s_726) && isDolar_701(last_727)) {
    var index = s_726.inner().first().val();
    (0, _errors.assert)(acc_725.rep.size > index, "unknown replacement value");
    var replacement = cloneLineNumber_708(acc_725.rep.get(index), beforeLast_728);
    return { template: acc_725.template.pop().concat(replacement), rep: acc_725.rep };
  } else if (isDelimiter_702(s_726)) {
    var innerResult = replaceTemplate(s_726.inner(), acc_725.rep);
    return { template: acc_725.template.push(insertIntoDelimiter_706(s_726, innerResult)), rep: acc_725.rep };
  } else {
    return { template: acc_725.template.push(s_726), rep: acc_725.rep };
  }
};
function processTemplate(temp_729) {
  var interp_730 = arguments.length <= 1 || arguments[1] === undefined ? (0, _immutable.List)() : arguments[1];

  return temp_729.reduce(process_707, { template: (0, _immutable.List)(), interp: interp_730 });
}
function replaceTemplate(temp_731, rep_732) {
  return temp_731.reduce(replace_709, { template: (0, _immutable.List)(), rep: rep_732 }).template;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3N3ZWV0L3RlbXBsYXRlLXByb2Nlc3Nvci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztRQTBDZ0IsZUFBZSxHQUFmLGVBQWU7UUFHZixlQUFlLEdBQWYsZUFBZTs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBeEMvQixJQUFNLFdBQVcsR0FBRyxTQUFkLFdBQVcsQ0FBRyxLQUFLO1NBQUksS0FBSyxJQUFJLEtBQUssNEJBQWtCLElBQUksS0FBSyxDQUFDLFlBQVksRUFBRSxJQUFJLEtBQUssQ0FBQyxHQUFHLEVBQUUsS0FBSyxHQUFHO0NBQUEsQ0FBQztBQUM3RyxJQUFNLGVBQWUsR0FBRyxTQUFsQixlQUFlLENBQUcsS0FBSztTQUFJLEtBQUssSUFBSSxPQUFPLEtBQUssQ0FBQyxXQUFXLEtBQUssVUFBVSxJQUFJLEtBQUssQ0FBQyxXQUFXLEVBQUU7Q0FBQSxDQUFDO0FBQ3pHLElBQU0sWUFBWSxHQUFHLFNBQWYsWUFBWSxDQUFHLEtBQUs7U0FBSSxLQUFLLElBQUksT0FBTyxLQUFLLENBQUMsUUFBUSxLQUFLLFVBQVUsSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFO0NBQUEsQ0FBQztBQUNoRyxJQUFNLFlBQVksR0FBRyxTQUFmLFlBQVksQ0FBRyxLQUFLO1NBQUksS0FBSyxJQUFJLE9BQU8sS0FBSyxDQUFDLFFBQVEsS0FBSyxVQUFVLElBQUksS0FBSyxDQUFDLFFBQVEsRUFBRTtDQUFBLENBQUM7QUFDaEcsSUFBTSxjQUFjLEdBQUcsU0FBakIsY0FBYyxDQUFHLEtBQUs7U0FBSSxLQUFLLElBQUksT0FBTyxLQUFLLENBQUMsVUFBVSxLQUFLLFVBQVUsSUFBSSxLQUFLLENBQUMsVUFBVSxFQUFFO0NBQUEsQ0FBQztBQUN0RyxJQUFNLHVCQUF1QixHQUFHLGdCQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsWUFBWSxFQUFFLFVBQUMsS0FBSyxFQUFFLEtBQUs7U0FBSyxpQkFBTyxVQUFVLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQztDQUFBLENBQUMs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QU0sSUFBSSxlQUFlLENBQUMsS0FBSyxDQUFDLEVBQUU7QUFDakMsUUFBSSxXQUFXLEdBQUcsZUFBZSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDOUQsV0FBTyxFQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUcsRUFBQyxDQUFDO0dBQ3pHLE1BQU07QUFDTCxXQUFPLEVBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRyxFQUFDLENBQUM7R0FDbkU7Q0FDRixDQUFDO0FBQ0ssU0FBUyxlQUFlLENBQUMsUUFBUSxFQUF1QjtNQUFyQixVQUFVLHlEQUFHLHNCQUFNOztBQUMzRCxTQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLEVBQUMsUUFBUSxFQUFFLHNCQUFNLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBQyxDQUFDLENBQUM7Q0FDN0U7QUFDTSxTQUFTLGVBQWUsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFO0FBQ2pELFNBQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsRUFBQyxRQUFRLEVBQUUsc0JBQU0sRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7Q0FDaEYiLCJmaWxlIjoidGVtcGxhdGUtcHJvY2Vzc29yLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtMaXN0fSBmcm9tIFwiaW1tdXRhYmxlXCI7XG5pbXBvcnQge01heWJlfSBmcm9tIFwicmFtZGEtZmFudGFzeVwiO1xuaW1wb3J0IF8gZnJvbSBcInJhbWRhXCI7XG5pbXBvcnQgU3ludGF4IGZyb20gXCIuL3N5bnRheFwiO1xuaW1wb3J0IHthc3NlcnR9IGZyb20gXCIuL2Vycm9yc1wiO1xuY29uc3QgaXNEb2xhcl83MDEgPSBzXzcxMCA9PiBzXzcxMCAmJiBzXzcxMCBpbnN0YW5jZW9mIFN5bnRheCAmJiBzXzcxMC5pc0lkZW50aWZpZXIoKSAmJiBzXzcxMC52YWwoKSA9PT0gXCIkXCI7XG5jb25zdCBpc0RlbGltaXRlcl83MDIgPSBzXzcxMSA9PiBzXzcxMSAmJiB0eXBlb2Ygc183MTEuaXNEZWxpbWl0ZXIgPT09IFwiZnVuY3Rpb25cIiAmJiBzXzcxMS5pc0RlbGltaXRlcigpO1xuY29uc3QgaXNCcmFjZXNfNzAzID0gc183MTIgPT4gc183MTIgJiYgdHlwZW9mIHNfNzEyLmlzQnJhY2VzID09PSBcImZ1bmN0aW9uXCIgJiYgc183MTIuaXNCcmFjZXMoKTtcbmNvbnN0IGlzUGFyZW5zXzcwNCA9IHNfNzEzID0+IHNfNzEzICYmIHR5cGVvZiBzXzcxMy5pc1BhcmVucyA9PT0gXCJmdW5jdGlvblwiICYmIHNfNzEzLmlzUGFyZW5zKCk7XG5jb25zdCBpc0JyYWNrZXRzXzcwNSA9IHNfNzE0ID0+IHNfNzE0ICYmIHR5cGVvZiBzXzcxNC5pc0JyYWNrZXRzID09PSBcImZ1bmN0aW9uXCIgJiYgc183MTQuaXNCcmFja2V0cygpO1xuY29uc3QgaW5zZXJ0SW50b0RlbGltaXRlcl83MDYgPSBfLmNvbmQoW1tpc0JyYWNlc183MDMsIChzXzcxNSwgcl83MTYpID0+IFN5bnRheC5mcm9tQnJhY2VzKHJfNzE2LCBzXzcxNSldLCBbaXNQYXJlbnNfNzA0LCAoc183MTcsIHJfNzE4KSA9PiBTeW50YXguZnJvbVBhcmVucyhyXzcxOCwgc183MTcpXSwgW2lzQnJhY2tldHNfNzA1LCAoc183MTksIHJfNzIwKSA9PiBTeW50YXguZnJvbUJyYWNrZXRzKHJfNzIwLCBzXzcxOSldXSk7XG5jb25zdCBwcm9jZXNzXzcwNyA9IChhY2NfNzIxLCBzXzcyMikgPT4ge1xuICBpZiAoaXNCcmFjZXNfNzAzKHNfNzIyKSAmJiBpc0RvbGFyXzcwMShhY2NfNzIxLnRlbXBsYXRlLmxhc3QoKSkpIHtcbiAgICByZXR1cm4ge3RlbXBsYXRlOiBhY2NfNzIxLnRlbXBsYXRlLnB1c2goU3ludGF4LmZyb21CcmFjZXMoTGlzdC5vZihTeW50YXguZnJvbU51bWJlcihhY2NfNzIxLmludGVycC5zaXplKSksIHNfNzIyKSksIGludGVycDogYWNjXzcyMS5pbnRlcnAucHVzaChzXzcyMi5pbm5lcigpKX07XG4gIH0gZWxzZSBpZiAoaXNEZWxpbWl0ZXJfNzAyKHNfNzIyKSkge1xuICAgIGxldCBpbm5lclJlc3VsdCA9IHByb2Nlc3NUZW1wbGF0ZShzXzcyMi5pbm5lcigpLCBhY2NfNzIxLmludGVycCk7XG4gICAgcmV0dXJuIHt0ZW1wbGF0ZTogYWNjXzcyMS50ZW1wbGF0ZS5wdXNoKGluc2VydEludG9EZWxpbWl0ZXJfNzA2KHNfNzIyLCBpbm5lclJlc3VsdC50ZW1wbGF0ZSkpLCBpbnRlcnA6IGlubmVyUmVzdWx0LmludGVycH07XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHt0ZW1wbGF0ZTogYWNjXzcyMS50ZW1wbGF0ZS5wdXNoKHNfNzIyKSwgaW50ZXJwOiBhY2NfNzIxLmludGVycH07XG4gIH1cbn07XG5mdW5jdGlvbiBjbG9uZUxpbmVOdW1iZXJfNzA4KHRvXzcyMywgZnJvbV83MjQpIHtcbiAgaWYgKGZyb21fNzI0ICYmIHRvXzcyMyAmJiB0eXBlb2YgdG9fNzIzLnNldExpbmVOdW1iZXIgPT09IFwiZnVuY3Rpb25cIikge1xuICAgIHJldHVybiB0b183MjMuc2V0TGluZU51bWJlcihmcm9tXzcyNC5saW5lTnVtYmVyKCkpO1xuICB9XG4gIHJldHVybiB0b183MjM7XG59XG5jb25zdCByZXBsYWNlXzcwOSA9IChhY2NfNzI1LCBzXzcyNikgPT4ge1xuICBsZXQgbGFzdF83MjcgPSBhY2NfNzI1LnRlbXBsYXRlLmdldCgtMSk7XG4gIGxldCBiZWZvcmVMYXN0XzcyOCA9IGFjY183MjUudGVtcGxhdGUuZ2V0KC0yKTtcbiAgaWYgKGlzQnJhY2VzXzcwMyhzXzcyNikgJiYgaXNEb2xhcl83MDEobGFzdF83MjcpKSB7XG4gICAgbGV0IGluZGV4ID0gc183MjYuaW5uZXIoKS5maXJzdCgpLnZhbCgpO1xuICAgIGFzc2VydChhY2NfNzI1LnJlcC5zaXplID4gaW5kZXgsIFwidW5rbm93biByZXBsYWNlbWVudCB2YWx1ZVwiKTtcbiAgICBsZXQgcmVwbGFjZW1lbnQgPSBjbG9uZUxpbmVOdW1iZXJfNzA4KGFjY183MjUucmVwLmdldChpbmRleCksIGJlZm9yZUxhc3RfNzI4KTtcbiAgICByZXR1cm4ge3RlbXBsYXRlOiBhY2NfNzI1LnRlbXBsYXRlLnBvcCgpLmNvbmNhdChyZXBsYWNlbWVudCksIHJlcDogYWNjXzcyNS5yZXB9O1xuICB9IGVsc2UgaWYgKGlzRGVsaW1pdGVyXzcwMihzXzcyNikpIHtcbiAgICBsZXQgaW5uZXJSZXN1bHQgPSByZXBsYWNlVGVtcGxhdGUoc183MjYuaW5uZXIoKSwgYWNjXzcyNS5yZXApO1xuICAgIHJldHVybiB7dGVtcGxhdGU6IGFjY183MjUudGVtcGxhdGUucHVzaChpbnNlcnRJbnRvRGVsaW1pdGVyXzcwNihzXzcyNiwgaW5uZXJSZXN1bHQpKSwgcmVwOiBhY2NfNzI1LnJlcH07XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHt0ZW1wbGF0ZTogYWNjXzcyNS50ZW1wbGF0ZS5wdXNoKHNfNzI2KSwgcmVwOiBhY2NfNzI1LnJlcH07XG4gIH1cbn07XG5leHBvcnQgZnVuY3Rpb24gcHJvY2Vzc1RlbXBsYXRlKHRlbXBfNzI5LCBpbnRlcnBfNzMwID0gTGlzdCgpKSB7XG4gIHJldHVybiB0ZW1wXzcyOS5yZWR1Y2UocHJvY2Vzc183MDcsIHt0ZW1wbGF0ZTogTGlzdCgpLCBpbnRlcnA6IGludGVycF83MzB9KTtcbn1cbmV4cG9ydCBmdW5jdGlvbiByZXBsYWNlVGVtcGxhdGUodGVtcF83MzEsIHJlcF83MzIpIHtcbiAgcmV0dXJuIHRlbXBfNzMxLnJlZHVjZShyZXBsYWNlXzcwOSwge3RlbXBsYXRlOiBMaXN0KCksIHJlcDogcmVwXzczMn0pLnRlbXBsYXRlO1xufVxuIl19