"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.sanitizeReplacementValues = sanitizeReplacementValues;

var _ramda = require("ramda");

var _ = _interopRequireWildcard(_ramda);

var _termExpander = require("./term-expander");

var _termExpander2 = _interopRequireDefault(_termExpander);

var _immutable = require("immutable");

var _parseReducer = require("./parse-reducer.js");

var _parseReducer2 = _interopRequireDefault(_parseReducer);

var _shiftReducer = require("shift-reducer");

var _shiftReducer2 = _interopRequireDefault(_shiftReducer);

var _serializer = require("./serializer");

var _syntax = require("./syntax");

var _syntax2 = _interopRequireDefault(_syntax);

var _shiftCodegen = require("shift-codegen");

var _shiftCodegen2 = _interopRequireDefault(_shiftCodegen);

var _transforms = require("./transforms");

var _terms = require("./terms");

var _terms2 = _interopRequireDefault(_terms);

var _shiftReader = require("./shift-reader");

var _shiftReader2 = _interopRequireDefault(_shiftReader);

var _macroContext = require("./macro-context");

var _templateProcessor = require("./template-processor");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

var geval_309 = eval;
function sanitizeReplacementValues(values_312) {
  if (Array.isArray(values_312)) {
    return sanitizeReplacementValues((0, _immutable.List)(values_312));
  } else if (_immutable.List.isList(values_312)) {
    return values_312.map(sanitizeReplacementValues);
  } else if (values_312 == null) {
    throw new Error("replacement values for syntax template must not be null or undefined");
  } else if (typeof values_312.next === "function") {
    return sanitizeReplacementValues((0, _immutable.List)(values_312));
  }
  return (0, _macroContext.unwrap)(values_312);
}
function loadForCompiletime_310(expr_313, context_314) {
  var deserializer_315 = (0, _serializer.makeDeserializer)(context_314.bindings);
  var sandbox_316 = { syntaxQuote: function syntaxQuote(strings_323) {
      for (var _len = arguments.length, values_322 = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        values_322[_key - 1] = arguments[_key];
      }

      var ctx_324 = deserializer_315.read(_.last(values_322));
      var reader_325 = new _shiftReader2.default(strings_323, ctx_324.context, _.take(values_322.length - 1, values_322));
      return reader_325.read();
    }, syntaxTemplate: function syntaxTemplate(str_327) {
      for (var _len2 = arguments.length, values_326 = Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {
        values_326[_key2 - 1] = arguments[_key2];
      }

      return (0, _templateProcessor.replaceTemplate)(deserializer_315.read(str_327), sanitizeReplacementValues(values_326));
    } };
  var sandboxKeys_317 = (0, _immutable.List)(Object.keys(sandbox_316));
  var sandboxVals_318 = sandboxKeys_317.map(function (k_328) {
    return sandbox_316[k_328];
  }).toArray();
  var parsed_319 = (0, _shiftReducer2.default)(new _parseReducer2.default(), new _terms2.default("Module", { directives: (0, _immutable.List)(), items: _immutable.List.of(new _terms2.default("ExpressionStatement", { expression: new _terms2.default("FunctionExpression", { isGenerator: false, name: null, params: new _terms2.default("FormalParameters", { items: sandboxKeys_317.map(function (param_329) {
            return new _terms2.default("BindingIdentifier", { name: _syntax2.default.fromIdentifier(param_329) });
          }), rest: null }), body: new _terms2.default("FunctionBody", { directives: _immutable.List.of(new _terms2.default("Directive", { rawValue: "use strict" })), statements: _immutable.List.of(new _terms2.default("ReturnStatement", { expression: expr_313 })) }) }) })) }));
  var gen_320 = (0, _shiftCodegen2.default)(parsed_319, new _shiftCodegen.FormattedCodeGen());
  var result_321 = context_314.transform(gen_320, { babelrc: true, filename: context_314.filename });
  return geval_309(result_321.code).apply(undefined, sandboxVals_318);
}
var loadSyntax_311 = _.cond([[_.where({ binding: _terms.isBindingIdentifier }), _.curry(function (_ref, context_330, env_331) {
  var binding = _ref.binding;
  var init = _ref.init;

  var termExpander_332 = new _termExpander2.default(context_330);
  var initValue_333 = loadForCompiletime_310(termExpander_332.expand(init), context_330);
  env_331.set(binding.name.resolve(), new _transforms.CompiletimeTransform(initValue_333));
})], [_.T, function (__334) {
  return assert(false, "not implemented yet");
}]]);
exports.default = loadSyntax_311;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3N3ZWV0L2xvYWQtc3ludGF4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O1FBY2dCLHlCQUF5QixHQUF6Qix5QkFBeUI7Ozs7SUFkNUIsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFhZCxJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUM7QUFDZCxTQUFTLHlCQUF5QixDQUFDLFVBQVUsRUFBRTtBQUNwRCxNQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUU7QUFDN0IsV0FBTyx5QkFBeUIsQ0FBQyxxQkFBSyxVQUFVLENBQUMsQ0FBQyxDQUFDO0dBQ3BELE1BQU0sSUFBSSxnQkFBSyxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUU7QUFDbEMsV0FBTyxVQUFVLENBQUMsR0FBRyxDQUFDLHlCQUF5QixDQUFDLENBQUM7R0FDbEQsTUFBTSxJQUFJLFVBQVUsSUFBSSxJQUFJLEVBQUU7QUFDN0IsVUFBTSxJQUFJLEtBQUssQ0FBQyxzRUFBc0UsQ0FBQyxDQUFDO0dBQ3pGLE1BQU0sSUFBSSxPQUFPLFVBQVUsQ0FBQyxJQUFJLEtBQUssVUFBVSxFQUFFO0FBQ2hELFdBQU8seUJBQXlCLENBQUMscUJBQUssVUFBVSxDQUFDLENBQUMsQ0FBQztHQUNwRDtBQUNELFNBQU8sMEJBQU8sVUFBVSxDQUFDLENBQUM7Q0FDM0I7QUFDRCxTQUFTLHNCQUFzQixDQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUU7QUFDckQsTUFBSSxnQkFBZ0IsR0FBRyxrQ0FBaUIsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzlELE1BQUksV0FBVyxHQUFHLEVBQUMsV0FBVyxFQUFFLHFCQUFVLFdBQVcsRUFBaUI7d0NBQVosVUFBVTtBQUFWLGtCQUFVOzs7QUFDbEUsVUFBSSxPQUFPLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztBQUN4RCxV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QUFhLENBQUMsQ0FBQyxDQUFDO0NBQzlFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxVQUFBLEtBQUs7U0FBSSxNQUFNLENBQUMsS0FBSyxFQUFFLHFCQUFxQixDQUFDO0NBQUEsQ0FBQyxDQUFDLENBQUMsQ0FBQztrQkFDN0MsY0FBYyIsImZpbGUiOiJsb2FkLXN5bnRheC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAgKiBhcyBfIGZyb20gXCJyYW1kYVwiO1xuaW1wb3J0IFRlcm1FeHBhbmRlciBmcm9tIFwiLi90ZXJtLWV4cGFuZGVyXCI7XG5pbXBvcnQge0xpc3R9IGZyb20gXCJpbW11dGFibGVcIjtcbmltcG9ydCBQYXJzZVJlZHVjZXIgZnJvbSBcIi4vcGFyc2UtcmVkdWNlci5qc1wiO1xuaW1wb3J0IHJlZHVjZXIsIHtNb25vaWRhbFJlZHVjZXJ9IGZyb20gXCJzaGlmdC1yZWR1Y2VyXCI7XG5pbXBvcnQge21ha2VEZXNlcmlhbGl6ZXJ9IGZyb20gXCIuL3NlcmlhbGl6ZXJcIjtcbmltcG9ydCBTeW50YXggZnJvbSBcIi4vc3ludGF4XCI7XG5pbXBvcnQgY29kZWdlbiwge0Zvcm1hdHRlZENvZGVHZW59IGZyb20gXCJzaGlmdC1jb2RlZ2VuXCI7XG5pbXBvcnQge1ZhckJpbmRpbmdUcmFuc2Zvcm0sIENvbXBpbGV0aW1lVHJhbnNmb3JtfSBmcm9tIFwiLi90cmFuc2Zvcm1zXCI7XG5pbXBvcnQgVGVybSwge2lzRU9GLCBpc0JpbmRpbmdJZGVudGlmaWVyLCBpc0Z1bmN0aW9uRGVjbGFyYXRpb24sIGlzRnVuY3Rpb25FeHByZXNzaW9uLCBpc0Z1bmN0aW9uVGVybSwgaXNGdW5jdGlvbldpdGhOYW1lLCBpc1N5bnRheERlY2xhcmF0aW9uLCBpc1ZhcmlhYmxlRGVjbGFyYXRpb24sIGlzVmFyaWFibGVEZWNsYXJhdGlvblN0YXRlbWVudCwgaXNJbXBvcnQsIGlzRXhwb3J0fSBmcm9tIFwiLi90ZXJtc1wiO1xuaW1wb3J0IFJlYWRlciBmcm9tIFwiLi9zaGlmdC1yZWFkZXJcIjtcbmltcG9ydCB7dW53cmFwfSBmcm9tIFwiLi9tYWNyby1jb250ZXh0XCI7XG5pbXBvcnQge3JlcGxhY2VUZW1wbGF0ZX0gZnJvbSBcIi4vdGVtcGxhdGUtcHJvY2Vzc29yXCI7XG5sZXQgZ2V2YWxfMzA5ID0gZXZhbDtcbmV4cG9ydCBmdW5jdGlvbiBzYW5pdGl6ZVJlcGxhY2VtZW50VmFsdWVzKHZhbHVlc18zMTIpIHtcbiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWVzXzMxMikpIHtcbiAgICByZXR1cm4gc2FuaXRpemVSZXBsYWNlbWVudFZhbHVlcyhMaXN0KHZhbHVlc18zMTIpKTtcbiAgfSBlbHNlIGlmIChMaXN0LmlzTGlzdCh2YWx1ZXNfMzEyKSkge1xuICAgIHJldHVybiB2YWx1ZXNfMzEyLm1hcChzYW5pdGl6ZVJlcGxhY2VtZW50VmFsdWVzKTtcbiAgfSBlbHNlIGlmICh2YWx1ZXNfMzEyID09IG51bGwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJyZXBsYWNlbWVudCB2YWx1ZXMgZm9yIHN5bnRheCB0ZW1wbGF0ZSBtdXN0IG5vdCBiZSBudWxsIG9yIHVuZGVmaW5lZFwiKTtcbiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWVzXzMxMi5uZXh0ID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICByZXR1cm4gc2FuaXRpemVSZXBsYWNlbWVudFZhbHVlcyhMaXN0KHZhbHVlc18zMTIpKTtcbiAgfVxuICByZXR1cm4gdW53cmFwKHZhbHVlc18zMTIpO1xufVxuZnVuY3Rpb24gbG9hZEZvckNvbXBpbGV0aW1lXzMxMChleHByXzMxMywgY29udGV4dF8zMTQpIHtcbiAgbGV0IGRlc2VyaWFsaXplcl8zMTUgPSBtYWtlRGVzZXJpYWxpemVyKGNvbnRleHRfMzE0LmJpbmRpbmdzKTtcbiAgbGV0IHNhbmRib3hfMzE2ID0ge3N5bnRheFF1b3RlOiBmdW5jdGlvbiAoc3RyaW5nc18zMjMsIC4uLnZhbHVlc18zMjIpIHtcbiAgICBsZXQgY3R4XzMyNCA9IGRlc2VyaWFsaXplcl8zMTUucmVhZChfLmxhc3QodmFsdWVzXzMyMikpO1xuICAgIGxldCByZWFkZXJfMzI1ID0gbmV3IFJlYWRlcihzdHJpbmdzXzMyMywgY3R4XzMyNC5jb250ZXh0LCBfLnRha2UodmFsdWVzXzMyMi5sZW5ndGggLSAxLCB2YWx1ZXNfMzIyKSk7XG4gICAgcmV0dXJuIHJlYWRlcl8zMjUucmVhZCgpO1xuICB9LCBzeW50YXhUZW1wbGF0ZTogZnVuY3Rpb24gKHN0cl8zMjcsIC4uLnZhbHVlc18zMjYpIHtcbiAgICByZXR1cm4gcmVwbGFjZVRlbXBsYXRlKGRlc2VyaWFsaXplcl8zMTUucmVhZChzdHJfMzI3KSwgc2FuaXRpemVSZXBsYWNlbWVudFZhbHVlcyh2YWx1ZXNfMzI2KSk7XG4gIH19O1xuICBsZXQgc2FuZGJveEtleXNfMzE3ID0gTGlzdChPYmplY3Qua2V5cyhzYW5kYm94XzMxNikpO1xuICBsZXQgc2FuZGJveFZhbHNfMzE4ID0gc2FuZGJveEtleXNfMzE3Lm1hcChrXzMyOCA9PiBzYW5kYm94XzMxNltrXzMyOF0pLnRvQXJyYXkoKTtcbiAgbGV0IHBhcnNlZF8zMTkgPSByZWR1Y2VyKG5ldyBQYXJzZVJlZHVjZXIsIG5ldyBUZXJtKFwiTW9kdWxlXCIsIHtkaXJlY3RpdmVzOiBMaXN0KCksIGl0ZW1zOiBMaXN0Lm9mKG5ldyBUZXJtKFwiRXhwcmVzc2lvblN0YXRlbWVudFwiLCB7ZXhwcmVzc2lvbjogbmV3IFRlcm0oXCJGdW5jdGlvbkV4cHJlc3Npb25cIiwge2lzR2VuZXJhdG9yOiBmYWxzZSwgbmFtZTogbnVsbCwgcGFyYW1zOiBuZXcgVGVybShcIkZvcm1hbFBhcmFtZXRlcnNcIiwge2l0ZW1zOiBzYW5kYm94S2V5c18zMTcubWFwKHBhcmFtXzMyOSA9PiB7XG4gICAgcmV0dXJuIG5ldyBUZXJtKFwiQmluZGluZ0lkZW50aWZpZXJcIiwge25hbWU6IFN5bnRheC5mcm9tSWRlbnRpZmllcihwYXJhbV8zMjkpfSk7XG4gIH0pLCByZXN0OiBudWxsfSksIGJvZHk6IG5ldyBUZXJtKFwiRnVuY3Rpb25Cb2R5XCIsIHtkaXJlY3RpdmVzOiBMaXN0Lm9mKG5ldyBUZXJtKFwiRGlyZWN0aXZlXCIsIHtyYXdWYWx1ZTogXCJ1c2Ugc3RyaWN0XCJ9KSksIHN0YXRlbWVudHM6IExpc3Qub2YobmV3IFRlcm0oXCJSZXR1cm5TdGF0ZW1lbnRcIiwge2V4cHJlc3Npb246IGV4cHJfMzEzfSkpfSl9KX0pKX0pKTtcbiAgbGV0IGdlbl8zMjAgPSBjb2RlZ2VuKHBhcnNlZF8zMTksIG5ldyBGb3JtYXR0ZWRDb2RlR2VuKTtcbiAgbGV0IHJlc3VsdF8zMjEgPSBjb250ZXh0XzMxNC50cmFuc2Zvcm0oZ2VuXzMyMCwge2JhYmVscmM6IHRydWUsIGZpbGVuYW1lOiBjb250ZXh0XzMxNC5maWxlbmFtZX0pO1xuICByZXR1cm4gZ2V2YWxfMzA5KHJlc3VsdF8zMjEuY29kZSkuYXBwbHkodW5kZWZpbmVkLCBzYW5kYm94VmFsc18zMTgpO1xufVxuY29uc3QgbG9hZFN5bnRheF8zMTEgPSBfLmNvbmQoW1tfLndoZXJlKHtiaW5kaW5nOiBpc0JpbmRpbmdJZGVudGlmaWVyfSksIF8uY3VycnkoKHtiaW5kaW5nLCBpbml0fSwgY29udGV4dF8zMzAsIGVudl8zMzEpID0+IHtcbiAgbGV0IHRlcm1FeHBhbmRlcl8zMzIgPSBuZXcgVGVybUV4cGFuZGVyKGNvbnRleHRfMzMwKTtcbiAgbGV0IGluaXRWYWx1ZV8zMzMgPSBsb2FkRm9yQ29tcGlsZXRpbWVfMzEwKHRlcm1FeHBhbmRlcl8zMzIuZXhwYW5kKGluaXQpLCBjb250ZXh0XzMzMCk7XG4gIGVudl8zMzEuc2V0KGJpbmRpbmcubmFtZS5yZXNvbHZlKCksIG5ldyBDb21waWxldGltZVRyYW5zZm9ybShpbml0VmFsdWVfMzMzKSk7XG59KV0sIFtfLlQsIF9fMzM0ID0+IGFzc2VydChmYWxzZSwgXCJub3QgaW1wbGVtZW50ZWQgeWV0XCIpXV0pO1xuZXhwb3J0IGRlZmF1bHQgbG9hZFN5bnRheF8zMTE7XG4iXX0=